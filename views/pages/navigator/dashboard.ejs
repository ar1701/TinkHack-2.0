<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Navigator Dashboard - MedConnect</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-blue: #2a5c82;
        --secondary-blue: #5c9baf;
        --accent-teal: #4ecdc4;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
      }

      body {
        background-color: var(--light-gray);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .dashboard-header {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .sidebar {
        background: white;
        min-height: calc(100vh - 60px);
        border-right: 1px solid var(--border-color);
        padding-top: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }

      .main-content {
        padding: 25px;
        background-color: var(--light-gray);
      }

      .nav-link {
        color: #333;
        padding: 0.8rem 1rem;
        border-radius: 0.5rem;
        margin: 0.3rem 0;
        transition: all 0.3s ease;
      }

      .nav-link.active {
        background-color: var(--accent-teal);
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .nav-link:hover:not(.active) {
        background: rgba(76, 205, 196, 0.1);
        color: var(--accent-teal);
      }

      .welcome-card {
        background: linear-gradient(
          135deg,
          var(--primary-blue) 0%,
          var(--secondary-blue) 100%
        );
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        border: none;
      }

      .card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-weight: 600;
        color: var(--primary-blue);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 12px;
        margin-bottom: 20px;
      }

      /* Badge styles */
      .request-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #dc3545;
        color: white;
        font-size: 12px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
      }

      /* Connection request styles */
      .request-card {
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      .request-card:hover {
        transform: translateY(-5px);
      }

      .message-preview {
        font-style: italic;
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 15px;
      }

      /* Stat card styles */
      .stat-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 20px;
        height: 100%;
        display: flex;
        align-items: center;
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .stat-patients-icon {
        background: var(--primary-blue);
      }

      .stat-appointments-icon {
        background: var(--accent-teal);
      }

      .stat-messages-icon {
        background: #ffc107;
      }

      .stat-tasks-icon {
        background: #6f42c1;
      }

      .stat-number {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      .stat-label {
        color: #6c757d;
        font-size: 14px;
      }

      /* Patient card styles */
      .patient-card .card {
        transition: transform 0.2s;
        height: 100%;
        border-radius: 12px;
      }

      .patient-info {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .patient-avatar {
        width: 40px;
        height: 40px;
        background: var(--primary-blue);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .patient-name {
        margin-bottom: 0;
        font-weight: 600;
      }

      .patient-details {
        font-size: 12px;
        color: #6c757d;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 30px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .status-high-risk {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
      }

      .status-medium-risk {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .patient-action-buttons {
        display: flex;
        gap: 10px;
      }

      .patient-action-buttons .btn {
        border-radius: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .patient-action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Task list styles */
      .task-list {
        list-style: none;
        padding: 0;
      }

      .task-item {
        display: flex;
        align-items: flex-start;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
        transition: transform 0.2s;
      }

      .task-item:hover {
        transform: translateX(5px);
      }

      .task-item:last-child {
        border-bottom: none;
      }

      .task-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(42, 92, 130, 0.1);
        color: var(--primary-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 16px;
      }

      .task-content {
        flex: 1;
      }

      .task-title {
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
      }

      .task-meta {
        display: flex;
        font-size: 12px;
        color: #6c757d;
        justify-content: space-between;
      }

      .overdue {
        color: #dc3545;
        font-weight: 500;
      }

      .btn-primary {
        background-color: var(--accent-teal);
        border-color: var(--accent-teal);
        border-radius: 30px;
        padding: 8px 20px;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .btn-outline-primary {
        color: var(--accent-teal);
        border-color: var(--accent-teal);
        border-radius: 30px;
        transition: all 0.3s ease;
      }

      .btn-outline-primary:hover {
        background-color: var(--accent-teal);
        color: white;
        border-color: var(--accent-teal);
      }

      .table {
        border-radius: 10px;
        overflow: hidden;
      }

      .table thead th {
        background-color: rgba(42, 92, 130, 0.05);
        color: var(--primary-blue);
        font-weight: 600;
        border-bottom: none;
      }

      .table-hover tbody tr:hover {
        background-color: rgba(76, 205, 196, 0.05);
      }

      .badge {
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 30px;
      }

      .form-control {
        border-radius: 30px;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .form-control:focus {
        border-color: var(--accent-teal);
        box-shadow: 0 0 0 0.25rem rgba(76, 205, 196, 0.25);
      }

      @media (max-width: 767.98px) {
        .sidebar {
          min-height: auto;
        }
        .main-content {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-header py-2">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h4 mb-0">
              <i class="fas fa-hospital me-2"></i>MedConnect
            </h1>
          </div>
          <div class="d-flex align-items-center">
            <div class="dropdown">
              <button
                class="btn btn-link text-white dropdown-toggle"
                type="button"
                id="userDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="fas fa-user-circle me-1"></i>
                <%= user.fullName %>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end shadow-sm"
                aria-labelledby="userDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/profile">
                    <i class="fas fa-user me-2"></i>Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/settings">
                    <i class="fas fa-cog me-2"></i>Settings
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="/logout">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-2 col-md-3 sidebar">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="/navigator/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/profile">
                <i class="fas fa-user-circle me-2"></i>My Profile
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/patient-management">
                <i class="fas fa-users me-2"></i>Patients
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/appointments">
                <i class="fas fa-calendar-alt me-2"></i>Appointments
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/tasks">
                <i class="fas fa-tasks me-2"></i>Tasks
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/messages">
                <i class="fas fa-envelope me-2"></i>Messages
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/navigator/reports">
                <i class="fas fa-chart-bar me-2"></i>Reports
              </a>
            </li>
          </ul>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10 col-md-9 main-content">
          <div class="welcome-card p-4 rounded mb-4">
            <h2>Welcome, <%= user.fullName %></h2>
            <p class="mb-0">
              Monitor patient progress, manage appointments, and coordinate care
              services.
            </p>
          </div>

          <!-- Statistics Section -->
          <div class="row mb-4">
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="stat-card">
                <div class="stat-icon stat-patients-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                  <h2 class="stat-number" data-target="12">0</h2>
                  <div class="stat-label">Active Patients</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-4">
              <div class="stat-card">
                <div class="stat-icon stat-appointments-icon">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                  <h2 class="stat-number" data-target="5">0</h2>
                  <div class="stat-label">Today's Appointments</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-4">
              <div class="stat-card">
                <div class="stat-icon stat-messages-icon">
                  <i class="fas fa-comments"></i>
                </div>
                <div class="stat-content">
                  <h2 class="stat-number" data-target="8">0</h2>
                  <div class="stat-label">Unread Messages</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-4">
              <div class="stat-card">
                <div class="stat-icon stat-tasks-icon">
                  <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-content">
                  <h2 class="stat-number" data-target="10">0</h2>
                  <div class="stat-label">Pending Tasks</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Connection Requests Section -->
            <div class="col-lg-6 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-user-plus me-2"></i>
                    Connection Requests
                    <span
                      class="badge bg-danger ms-2"
                      id="requestBadge"
                      style="display: none"
                      >0</span
                    >
                  </h5>

                  <div id="requestsContainer">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 text-muted">
                        Loading connection requests...
                      </p>
                    </div>
                  </div>

                  <div class="text-center mt-3">
                    <a href="/navigator/requests" class="btn btn-primary">
                      <i class="fas fa-user-plus me-2"></i>View All Requests
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Active Patients Section -->
            <div class="col-lg-6 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-users me-2"></i>
                    Active Patients
                  </h5>

                  <div id="activePatientsContainer">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 text-muted">Loading active patients...</p>
                    </div>
                  </div>

                  <div class="text-center mt-3">
                    <a href="/navigator/messages" class="btn btn-primary">
                      <i class="fas fa-comments me-2"></i>Message Patients
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Patient Overview Section -->
            <div class="col-lg-7 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-users me-2"></i>
                    My Patients
                  </h5>

                  <div class="mb-3">
                    <input
                      type="text"
                      class="form-control"
                      id="patientSearch"
                      placeholder="Search patients..."
                      onkeyup="filterPatients()"
                    />
                  </div>

                  <div class="row">
                    <!-- High Risk Patient -->
                    <div class="col-md-6 mb-3 patient-card">
                      <div class="card">
                        <div class="card-body">
                          <div class="patient-info">
                            <div class="patient-avatar">JD</div>
                            <div>
                              <h6 class="patient-name">John Doe</h6>
                              <div class="patient-details">42 years • Male</div>
                            </div>
                          </div>

                          <div class="status-badge status-high-risk">
                            <i class="fas fa-exclamation-triangle me-2"></i>High
                            Risk
                          </div>

                          <div class="small text-muted mb-2">
                            <i class="fas fa-stethoscope me-1"></i> Last
                            Screened: 3 days ago
                          </div>

                          <div class="patient-action-buttons">
                            <button class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-user-md me-1"></i> Profile
                            </button>
                            <button class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-phone-alt me-1"></i> Contact
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Medium Risk Patient -->
                    <div class="col-md-6 mb-3 patient-card">
                      <div class="card">
                        <div class="card-body">
                          <div class="patient-info">
                            <div class="patient-avatar">JS</div>
                            <div>
                              <h6 class="patient-name">Jane Smith</h6>
                              <div class="patient-details">
                                35 years • Female
                              </div>
                            </div>
                          </div>

                          <div class="status-badge status-medium-risk">
                            <i class="fas fa-exclamation-circle me-2"></i>Medium
                            Risk
                          </div>

                          <div class="small text-muted mb-2">
                            <i class="fas fa-stethoscope me-1"></i> Last
                            Screened: 5 days ago
                          </div>

                          <div class="patient-action-buttons">
                            <button class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-user-md me-1"></i> Profile
                            </button>
                            <button class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-phone-alt me-1"></i> Contact
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="text-center mt-3">
                    <a
                      href="/navigator/patient-management"
                      class="btn btn-primary"
                    >
                      <i class="fas fa-users me-2"></i>View All Patients
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tasks & Reminders Section -->
            <div class="col-lg-5 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Upcoming Tasks
                  </h5>

                  <ul class="task-list">
                    <li class="task-item">
                      <div class="task-icon">
                        <i class="fas fa-phone-alt"></i>
                      </div>
                      <div class="task-content">
                        <div class="task-title">
                          Follow-up call with John Doe
                        </div>
                        <div class="task-meta">
                          <div class="task-patient">
                            <i class="fas fa-user me-1"></i>John Doe
                          </div>
                          <div class="task-due overdue">
                            <i class="fas fa-clock me-1"></i>Today, 2:00 PM
                          </div>
                        </div>
                      </div>
                    </li>

                    <li class="task-item">
                      <div class="task-icon">
                        <i class="fas fa-file-medical"></i>
                      </div>
                      <div class="task-content">
                        <div class="task-title">Review medical records</div>
                        <div class="task-meta">
                          <div class="task-patient">
                            <i class="fas fa-user me-1"></i>Jane Smith
                          </div>
                          <div class="task-due">
                            <i class="fas fa-clock me-1"></i>Tomorrow, 10:00 AM
                          </div>
                        </div>
                      </div>
                    </li>

                    <li class="task-item">
                      <div class="task-icon">
                        <i class="fas fa-calendar-check"></i>
                      </div>
                      <div class="task-content">
                        <div class="task-title">
                          Schedule follow-up appointment
                        </div>
                        <div class="task-meta">
                          <div class="task-patient">
                            <i class="fas fa-user me-1"></i>Robert Johnson
                          </div>
                          <div class="task-due">
                            <i class="fas fa-clock me-1"></i>Jun 24, 9:00 AM
                          </div>
                        </div>
                      </div>
                    </li>

                    <li class="task-item">
                      <div class="task-icon">
                        <i class="fas fa-clipboard-list"></i>
                      </div>
                      <div class="task-content">
                        <div class="task-title">Update care plan</div>
                        <div class="task-meta">
                          <div class="task-patient">
                            <i class="fas fa-user me-1"></i>Maria Rodriguez
                          </div>
                          <div class="task-due">
                            <i class="fas fa-clock me-1"></i>Jun 25, 11:00 AM
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>

                  <div class="text-center mt-3">
                    <button class="btn btn-primary">View All Tasks</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Recent Activities -->
            <div class="col-12 mb-4">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-history me-2"></i>
                    Recent Activities
                  </h5>

                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Patient</th>
                          <th>Activity</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>Today, 10:30 AM</td>
                          <td>John Doe</td>
                          <td>Baseline health screening completed</td>
                          <td>
                            <span class="badge bg-success">Completed</span>
                          </td>
                        </tr>
                        <tr>
                          <td>Today, 9:15 AM</td>
                          <td>Jane Smith</td>
                          <td>New medical record uploaded</td>
                          <td><span class="badge bg-info">New</span></td>
                        </tr>
                        <tr>
                          <td>Yesterday, 3:45 PM</td>
                          <td>Robert Johnson</td>
                          <td>Appointment scheduled</td>
                          <td>
                            <span class="badge bg-primary">Scheduled</span>
                          </td>
                        </tr>
                        <tr>
                          <td>Yesterday, 11:20 AM</td>
                          <td>Maria Rodriguez</td>
                          <td>Care plan updated</td>
                          <td>
                            <span class="badge bg-success">Completed</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="text-center mt-3">
                    <button class="btn btn-primary">View All Activities</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Function to filter patients
      function filterPatients() {
        var input, filter, cards, card, name, i;
        input = document.getElementById("patientSearch");
        filter = input.value.toUpperCase();
        cards = document.getElementsByClassName("patient-card");

        for (i = 0; i < cards.length; i++) {
          name = cards[i].getElementsByClassName("patient-name")[0];
          if (name.innerHTML.toUpperCase().indexOf(filter) > -1) {
            cards[i].style.display = "";
          } else {
            cards[i].style.display = "none";
          }
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Counter animation for stats
        animateStatNumbers();

        // Load connection requests
        loadConnectionRequests();

        // Load active patients
        loadActivePatients();
      });

      // Animate stat counters
      function animateStatNumbers() {
        const statNumbers = document.querySelectorAll(".stat-number");

        statNumbers.forEach((number) => {
          const target = parseInt(number.getAttribute("data-target"));
          let count = 0;
          const duration = 2000; // ms
          const increment = target / (duration / 30);

          const updateCount = () => {
            if (count < target) {
              count += increment;
              number.textContent = Math.ceil(count);
              setTimeout(updateCount, 30);
            } else {
              number.textContent = target;
            }
          };

          updateCount();
        });
      }

      // Load connection requests from API
      function loadConnectionRequests() {
        fetch("/api/navigator/connection-requests")
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              showErrorMessage("requestsContainer", "Error loading requests");
              return;
            }

            // Update badge count
            updateRequestBadge(data.requests ? data.requests.length : 0);

            if (!data.requests || data.requests.length === 0) {
              showEmptyState(
                "requestsContainer",
                "No Connection Requests",
                "You don't have any pending connection requests from patients"
              );
              return;
            }

            // Only show up to 2 requests on dashboard
            const displayRequests = data.requests.slice(0, 2);
            renderRequests(displayRequests);
          })
          .catch((error) => {
            console.error("Error loading requests:", error);
            showErrorMessage("requestsContainer", "Error loading requests");
          });
      }

      // Load active patients from API
      function loadActivePatients() {
        fetch("/api/navigator/active-patients")
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              showErrorMessage(
                "activePatientsContainer",
                "Error loading patients"
              );
              return;
            }

            if (!data.connections || data.connections.length === 0) {
              showEmptyState(
                "activePatientsContainer",
                "No Active Patients",
                "You don't have any active patients connected with you yet"
              );
              return;
            }

            // Only show up to 2 patients on dashboard
            const displayPatients = data.connections.slice(0, 2);
            renderActivePatients(displayPatients);

            // Update active patients stat
            document
              .querySelector(".stat-patients-icon")
              .parentNode.querySelector(".stat-number").textContent =
              data.connections.length;
            document
              .querySelector(".stat-patients-icon")
              .parentNode.querySelector(".stat-number")
              .setAttribute("data-target", data.connections.length);
          })
          .catch((error) => {
            console.error("Error loading active patients:", error);
            showErrorMessage(
              "activePatientsContainer",
              "Error loading patients"
            );
          });
      }

      // Update request badge count
      function updateRequestBadge(count) {
        const requestBadge = document.getElementById("requestBadge");
        if (count > 0) {
          requestBadge.textContent = count;
          requestBadge.style.display = "inline-block";
        } else {
          requestBadge.style.display = "none";
        }
      }

      // Show error message
      function showErrorMessage(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="alert alert-danger">
            ${message}
          </div>
        `;
      }

      // Show empty state when no data
      function showEmptyState(containerId, title, subtitle) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-${
              containerId === "requestsContainer" ? "user-plus" : "users"
            } mb-3"></i>
            <h5>${title}</h5>
            <p class="text-muted">${subtitle}</p>
          </div>
        `;
      }

      // Render connection requests
      function renderRequests(requests) {
        const container = document.getElementById("requestsContainer");
        let html = "";

        requests.forEach((request) => {
          const patient = request.patient;

          // Create initials for avatar
          const nameParts = patient.fullName.split(" ");
          const initials =
            nameParts.length > 1
              ? `${nameParts[0].charAt(0)}${nameParts[1].charAt(0)}`
              : patient.fullName.charAt(0);

          // Format request date
          const requestDate = new Date(request.createdAt).toLocaleDateString(
            "en-US",
            {
              year: "numeric",
              month: "short",
              day: "numeric",
            }
          );

          html += `
            <div class="request-card mb-3" id="request-${request._id}">
              <div class="d-flex align-items-center mb-2">
                <div class="patient-avatar me-3">${initials}</div>
                <div>
                  <h6 class="mb-0">${patient.fullName}</h6>
                  <small class="text-muted">${patient.email}</small>
                </div>
              </div>
              <div class="message-preview">"${request.message}"</div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i> ${requestDate}
                </small>
                <div>
                  <button class="btn btn-sm btn-success me-2" onclick="handleRequest('${request._id}', 'accepted')">
                    <i class="fas fa-check me-1"></i> Accept
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="handleRequest('${request._id}', 'rejected')">
                    <i class="fas fa-times me-1"></i> Reject
                  </button>
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      // Render active patients
      function renderActivePatients(connections) {
        const container = document.getElementById("activePatientsContainer");
        let html = "";

        connections.forEach((connection) => {
          const patient = connection.patient;

          // Create initials for avatar
          const nameParts = patient.fullName.split(" ");
          const initials =
            nameParts.length > 1
              ? `${nameParts[0].charAt(0)}${nameParts[1].charAt(0)}`
              : patient.fullName.charAt(0);

          // Format connection date
          const connectionDate = new Date(
            connection.updatedAt
          ).toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });

          html += `
            <div class="patient-card mb-3">
              <div class="d-flex align-items-center mb-2">
                <div class="patient-avatar me-3">${initials}</div>
                <div>
                  <h6 class="patient-name mb-0">${patient.fullName}</h6>
                  <small class="text-muted">${patient.email}</small>
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">
                  <i class="fas fa-calendar-check me-1"></i> Connected since ${connectionDate}
                </small>
                <a href="/navigator/messages" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-comments me-1"></i> Message
                </a>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      // Handle request acceptance/rejection
      function handleRequest(requestId, status) {
        // Get the request card element
        const requestCard = document.getElementById(`request-${requestId}`);

        // Disable buttons
        const buttons = requestCard.querySelectorAll("button");
        buttons.forEach((button) => {
          button.disabled = true;
          button.innerHTML =
            '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';
        });

        // Send update request to server
        fetch(`/api/navigator/connection-requests/${requestId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              alert(data.message || "Error updating request");
              buttons.forEach((button) => (button.disabled = false));
              return;
            }

            // Show success message
            requestCard.innerHTML = `
            <div class="alert alert-${
              status === "accepted" ? "success" : "info"
            } mb-0">
              <i class="fas fa-${
                status === "accepted" ? "check-circle" : "info-circle"
              } me-2"></i>
              Request ${
                status === "accepted" ? "accepted" : "rejected"
              } successfully
            </div>
          `;

            // Remove request after 3 seconds
            setTimeout(() => {
              requestCard.style.opacity = "0";
              requestCard.style.height = "0";
              requestCard.style.margin = "0";
              requestCard.style.padding = "0";
              requestCard.style.transition = "all 0.5s ease";

              setTimeout(() => {
                requestCard.remove();

                // Check if there are no more requests
                const remainingRequests = document.querySelectorAll(
                  "#requestsContainer .request-card"
                ).length;

                if (remainingRequests === 0) {
                  showEmptyState(
                    "requestsContainer",
                    "No Connection Requests",
                    "You don't have any pending connection requests from patients"
                  );

                  // Update badge count
                  updateRequestBadge(0);
                } else {
                  // Update badge count
                  updateRequestBadge(remainingRequests);
                }

                // If request was accepted, reload active patients
                if (status === "accepted") {
                  loadActivePatients();
                }
              }, 500);
            }, 3000);
          })
          .catch((error) => {
            console.error("Error updating request:", error);
            alert("An error occurred. Please try again.");
            buttons.forEach((button) => (button.disabled = false));
          });
      }
    </script>
  </body>
</html>
