<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Details | Caregiver Portal</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .sidebar {
        background-color: #167997cc;
        height: 100vh;
        position: fixed;
        padding-top: 20px;
      }
      .sidebar a {
        color: #fff;
        padding: 10px 15px;
        display: block;
        text-decoration: none;
        transition: all 0.3s;
      }
      .sidebar a:hover,
      .sidebar a.active {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .main-content {
        margin-left: 250px;
        padding: 20px;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .card-header {
        background-color: #136179cc;
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 15px 20px;
      }
      .patient-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .patient-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
        border: 3px solid #eee;
      }
      .patient-name {
        margin: 0;
        font-size: 24px;
      }
      .patient-info {
        color: #6c757d;
      }
      .action-buttons {
        margin-top: 15px;
      }
      .action-btn {
        margin-right: 10px;
      }
      .patient-info-section {
        margin-bottom: 15px;
      }
      .patient-info-section h5 {
        font-size: 16px;
        margin-bottom: 8px;
        color: #5a5c69;
      }
      .patient-info-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .patient-info-list li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .patient-info-list li:last-child {
        border-bottom: none;
      }
      .info-label {
        color: #6c757d;
        font-weight: 500;
      }
      .nav-tabs .nav-link {
        color: #495057;
      }
      .nav-tabs .nav-link.active {
        color: #136179cc;
        font-weight: 600;
      }
      .tab-content {
        padding: 20px;
      }
      .empty-state {
        text-align: center;
        padding: 30px 0;
      }
      .empty-icon {
        font-size: 48px;
        color: #dee2e6;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar">
          <h3 class="text-white px-3 mb-4">Caregiver Portal</h3>
          <ul class="nav flex-column">
            <%- include('../../partials/sidebar') %>
          </ul>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content">
          <div class="patient-header">
            <img
              src="<%= patient.profileImage ? `/uploads/profile/${patient.profileImage}` : '/images/default-user.jpg' %>"
              alt="<%= patient.fullName %>"
              class="patient-image"
            />
            <div>
              <h1 class="patient-name"><%= patient.fullName %></h1>
              <p class="patient-info">
                <% if (patient.age) { %><%= patient.age %> years old • <% } %>
                <% if (patient.gender) { %><%= patient.gender %> • <% } %> <% if
                (patient.bloodGroup) { %>Blood Group: <%= patient.bloodGroup
                %><% } %>
              </p>
              <div class="action-buttons">
                <a
                  href="/caregiver/chat/<%= patient._id %>"
                  class="btn btn-primary action-btn"
                >
                  <i class="fas fa-comments me-2"></i>Message
                </a>
                <a
                  href="/caregiver/appointments/<%= patient._id %>/schedule"
                  class="btn btn-outline-primary action-btn"
                >
                  <i class="fas fa-calendar-plus me-2"></i>Schedule Appointment
                </a>
              </div>
            </div>
          </div>

          <!-- Patient Information Tabs -->
          <div class="card">
            <div class="card-header">
              <ul
                class="nav nav-tabs card-header-tabs"
                id="patientTabs"
                role="tablist"
              >
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="info-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#info"
                    type="button"
                    role="tab"
                    aria-controls="info"
                    aria-selected="true"
                  >
                    <i class="fas fa-user me-2"></i>Patient Information
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="medical-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#medical"
                    type="button"
                    role="tab"
                    aria-controls="medical"
                    aria-selected="false"
                  >
                    <i class="fas fa-file-medical me-2"></i>Medical History
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="appointments-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#appointments"
                    type="button"
                    role="tab"
                    aria-controls="appointments"
                    aria-selected="false"
                  >
                    <i class="fas fa-calendar-check me-2"></i>Appointments
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="chat-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#chat"
                    type="button"
                    role="tab"
                    aria-controls="chat"
                    aria-selected="false"
                  >
                    <i class="fas fa-comments me-2"></i>Chat History
                  </button>
                </li>
              </ul>
            </div>
            <div class="card-body">
              <div class="tab-content" id="patientTabsContent">
                <!-- Patient Info Tab -->
                <div
                  class="tab-pane fade show active"
                  id="info"
                  role="tabpanel"
                  aria-labelledby="info-tab"
                >
                  <div class="row">
                    <div class="col-md-6">
                      <div class="patient-info-section">
                        <h5>Contact Information</h5>
                        <ul class="patient-info-list">
                          <li>
                            <span class="info-label">Email:</span>
                            <span><%= patient.email || 'Not provided' %></span>
                          </li>
                          <li>
                            <span class="info-label">Phone:</span>
                            <span><%= patient.phone || 'Not provided' %></span>
                          </li>
                          <li>
                            <span class="info-label">Address:</span>
                            <span
                              ><%= patient.address || 'Not provided' %></span
                            >
                          </li>
                        </ul>
                      </div>

                      <div class="patient-info-section">
                        <h5>Emergency Contact</h5>
                        <% if (patient.emergencyContact &&
                        patient.emergencyContact.name) { %>
                        <ul class="patient-info-list">
                          <li>
                            <span class="info-label">Name:</span>
                            <span><%= patient.emergencyContact.name %></span>
                          </li>
                          <li>
                            <span class="info-label">Relationship:</span>
                            <span
                              ><%= patient.emergencyContact.relationship || 'Not
                              specified' %></span
                            >
                          </li>
                          <li>
                            <span class="info-label">Phone:</span>
                            <span
                              ><%= patient.emergencyContact.phoneNumber || 'Not
                              provided' %></span
                            >
                          </li>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">
                          No emergency contact information provided
                        </p>
                        <% } %>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="patient-info-section">
                        <h5>Insurance Information</h5>
                        <% if (patient.insuranceDetails &&
                        patient.insuranceDetails.provider) { %>
                        <ul class="patient-info-list">
                          <li>
                            <span class="info-label">Provider:</span>
                            <span
                              ><%= patient.insuranceDetails.provider %></span
                            >
                          </li>
                          <li>
                            <span class="info-label">Policy Number:</span>
                            <span
                              ><%= patient.insuranceDetails.policyNumber || 'Not
                              provided' %></span
                            >
                          </li>
                          <li>
                            <span class="info-label">Valid Until:</span>
                            <span>
                              <% if (patient.insuranceDetails.validUntil) { %>
                              <%= new
                              Date(patient.insuranceDetails.validUntil).toLocaleDateString()
                              %> <% } else { %> Not specified <% } %>
                            </span>
                          </li>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">
                          No insurance information provided
                        </p>
                        <% } %>
                      </div>

                      <div class="patient-info-section">
                        <h5>Request Information</h5>
                        <ul class="patient-info-list">
                          <li>
                            <span class="info-label">Request Date:</span>
                            <span
                              ><%= request ? new
                              Date(request.createdAt).toLocaleDateString() :
                              'Not available' %></span
                            >
                          </li>
                          <li>
                            <span class="info-label">Reason for Request:</span>
                            <span
                              ><%= request ? request.reason : 'Not provided'
                              %></span
                            >
                          </li>
                          <li>
                            <span class="info-label">Status:</span>
                            <span class="badge bg-success">Connected</span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Medical History Tab -->
                <div
                  class="tab-pane fade"
                  id="medical"
                  role="tabpanel"
                  aria-labelledby="medical-tab"
                >
                  <% if (patient.medicalHistory) { %>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="patient-info-section">
                        <h5>Allergies</h5>
                        <% if (patient.medicalHistory.allergies &&
                        patient.medicalHistory.allergies.length > 0) { %>
                        <ul>
                          <%
                          patient.medicalHistory.allergies.forEach(function(allergy)
                          { %>
                          <li><%= allergy %></li>
                          <% }); %>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">No allergies reported</p>
                        <% } %>
                      </div>

                      <div class="patient-info-section">
                        <h5>Chronic Conditions</h5>
                        <% if (patient.medicalHistory.chronicConditions &&
                        patient.medicalHistory.chronicConditions.length > 0) {
                        %>
                        <ul>
                          <%
                          patient.medicalHistory.chronicConditions.forEach(function(condition)
                          { %>
                          <li><%= condition %></li>
                          <% }); %>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">No chronic conditions reported</p>
                        <% } %>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="patient-info-section">
                        <h5>Current Medications</h5>
                        <% if (patient.medicalHistory.medications &&
                        patient.medicalHistory.medications.length > 0) { %>
                        <ul>
                          <%
                          patient.medicalHistory.medications.forEach(function(medication)
                          { %>
                          <li>
                            <strong><%= medication.name %></strong> - <%=
                            medication.dosage %>, <%= medication.frequency %> <%
                            if (medication.startDate) { %>
                            <div class="small text-muted">
                              Started: <%= new
                              Date(medication.startDate).toLocaleDateString() %>
                              <% if (medication.endDate) { %> | Until: <%= new
                              Date(medication.endDate).toLocaleDateString() %>
                              <% } %>
                            </div>
                            <% } %>
                          </li>
                          <% }); %>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">
                          No current medications reported
                        </p>
                        <% } %>
                      </div>

                      <div class="patient-info-section">
                        <h5>Past Surgeries</h5>
                        <% if (patient.medicalHistory.surgeries &&
                        patient.medicalHistory.surgeries.length > 0) { %>
                        <ul>
                          <%
                          patient.medicalHistory.surgeries.forEach(function(surgery)
                          { %>
                          <li>
                            <strong><%= surgery.name %></strong>
                            <% if (surgery.date) { %> - <%= new
                            Date(surgery.date).toLocaleDateString() %> <% } %>
                            <% if (surgery.notes) { %>
                            <div class="small"><%= surgery.notes %></div>
                            <% } %>
                          </li>
                          <% }); %>
                        </ul>
                        <% } else { %>
                        <p class="text-muted">No past surgeries reported</p>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <% } else { %>
                  <div class="empty-state">
                    <div class="empty-icon">
                      <i class="fas fa-file-medical"></i>
                    </div>
                    <h3>No Medical History</h3>
                    <p class="text-muted">
                      The patient has not provided any medical history
                      information yet.
                    </p>
                  </div>
                  <% } %>
                </div>

                <!-- Appointments Tab -->
                <div
                  class="tab-pane fade"
                  id="appointments"
                  role="tabpanel"
                  aria-labelledby="appointments-tab"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <h5>Upcoming Appointments</h5>
                    <a
                      href="/caregiver/appointments/<%= patient._id %>/schedule"
                      class="btn btn-sm btn-primary"
                    >
                      <i class="fas fa-plus me-1"></i> Schedule New
                    </a>
                  </div>

                  <% if (appointments && appointments.length > 0) { %>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Date & Time</th>
                          <th>Type</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% appointments.forEach(function(appointment) { %>
                        <tr>
                          <td>
                            <%= new Date(appointment.dateTime).toLocaleString()
                            %>
                          </td>
                          <td><%= appointment.type %></td>
                          <td>
                            <span
                              class="badge <%= appointment.status === 'scheduled' ? 'bg-success' : (appointment.status === 'cancelled' ? 'bg-danger' : 'bg-warning') %>"
                            >
                              <%= appointment.status %>
                            </span>
                          </td>
                          <td>
                            <div class="btn-group">
                              <a
                                href="/caregiver/appointments/<%= appointment._id %>"
                                class="btn btn-sm btn-outline-primary"
                                >View</a
                              >
                              <button class="btn btn-sm btn-outline-danger">
                                Cancel
                              </button>
                            </div>
                          </td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                  <% } else { %>
                  <div class="empty-state">
                    <div class="empty-icon">
                      <i class="fas fa-calendar"></i>
                    </div>
                    <h3>No Appointments</h3>
                    <p class="text-muted">
                      There are no scheduled appointments with this patient.
                    </p>
                    <a
                      href="/caregiver/appointments/<%= patient._id %>/schedule"
                      class="btn btn-primary mt-2"
                    >
                      <i class="fas fa-calendar-plus me-2"></i>Schedule First
                      Appointment
                    </a>
                  </div>
                  <% } %>
                </div>

                <!-- Chat History Tab -->
                <div
                  class="tab-pane fade"
                  id="chat"
                  role="tabpanel"
                  aria-labelledby="chat-tab"
                >
                  <div class="chat-container" id="chatContainer">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5>Recent Messages</h5>
                      <a
                        href="/caregiver/chat/<%= patient._id %>"
                        class="btn btn-sm btn-primary"
                      >
                        <i class="fas fa-comments me-1"></i> Open Full Chat
                      </a>
                    </div>

                    <div
                      class="chat-messages border rounded p-3 mb-3"
                      style="height: 300px; overflow-y: auto"
                      id="messagesContainer"
                    >
                      <% if (messages && messages.length > 0) { %> <%
                      messages.forEach(function(message) { %>
                      <div
                        class="message <%= message.sender === 'caregiver' ? 'text-end' : '' %> mb-2"
                      >
                        <div
                          class="message-content d-inline-block p-2 rounded <%= message.sender === 'caregiver' ? 'bg-primary text-white' : 'bg-light' %>"
                          style="max-width: 75%"
                        >
                          <%= message.content %>
                          <div class="message-time">
                            <small class="text-muted"
                              ><%= new Date(message.timestamp).toLocaleString()
                              %></small
                            >
                          </div>
                        </div>
                      </div>
                      <% }); %> <% } else { %>
                      <div class="text-center py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p>No messages yet</p>
                        <p class="text-muted">
                          Start a conversation with this patient
                        </p>
                      </div>
                      <% } %>
                    </div>

                    <form id="quickMessageForm" class="quick-message-form">
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="messageInput"
                          placeholder="Type a quick message..."
                          required
                        />
                        <button class="btn btn-primary" type="submit">
                          <i class="fas fa-paper-plane"></i> Send
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(document).ready(function () {
        // Initialize Socket.io connection
        const socket = io({
          auth: {
            userId: "<%= user._id %>",
          },
        });

        const patientId = "<%= patient._id %>";

        // Handle form submission for quick message
        $("#quickMessageForm").submit(function (e) {
          e.preventDefault();

          const messageText = $("#messageInput").val().trim();
          if (!messageText) return;

          // Send message via socket
          socket.emit("private-message", {
            receiverId: patientId,
            message: messageText,
          });

          // Clear the input
          $("#messageInput").val("");

          // Add message to UI
          const messageElement = `
            <div class="message text-end mb-2">
              <div class="message-content d-inline-block p-2 rounded bg-primary text-white" style="max-width: 75%">
                ${messageText}
                <div class="message-time">
                  <small class="text-muted">Just now</small>
                </div>
              </div>
            </div>
          `;

          $("#messagesContainer").append(messageElement);
          scrollToBottom();
        });

        // Handle new messages
        socket.on("new-message", function (data) {
          if (
            data.message.sender === patientId ||
            data.message.receiver === patientId
          ) {
            const messageElement = `
              <div class="message ${data.isSenderView ? "text-end" : ""} mb-2">
                <div class="message-content d-inline-block p-2 rounded ${
                  data.isSenderView ? "bg-primary text-white" : "bg-light"
                }" style="max-width: 75%">
                  ${data.message.message}
                  <div class="message-time">
                    <small class="text-muted">Just now</small>
                  </div>
                </div>
              </div>
            `;

            $("#messagesContainer").append(messageElement);
            scrollToBottom();
          }
        });

        // Function to scroll chat to bottom
        function scrollToBottom() {
          const messagesContainer =
            document.getElementById("messagesContainer");
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Initial scroll to bottom
        scrollToBottom();
      });
    </script>
  </body>
</html>
